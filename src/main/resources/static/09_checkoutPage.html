<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/main.css">
    <link rel="stylesheet" href="./css/08_shopping_cart.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://kit.fontawesome.com/e72344855b.js" crossorigin="anonymous"></script>
    <script src="./js/isLogin.js" type="module"></script>
    <title>Checkout Page</title>

</head>
<body>
<nav class="header">
    <div class="d-flex">
        <a class="iconBorder" href=""><img class="icon" src="./images/icon.png"></a>
        <div class="search-container">
            <div class="search-bar">
                <input type="text" class="search-input" placeholder="Search...">
                <div class="search-icon">
                    <i class="fas fa-search"></i>
                </div>
            </div>
            <div class="popular-categories">
                <ul>
                    <li>洗衣精</li>
                    <li>花盆</li>
                    <li>衛生紙</li>
                    <li>吹風機</li>
                    <li>剪刀</li>
                    <li>手機殼</li>
                    <li>梳子</li>
                    <li>桌墊</li>
                    <li>馬克杯</li>
                    <li>聖誕樹</li>
                    <li>聖誕裝飾品</li>
                    <li>鉛筆盒</li>
                    <li>耳機</li>
                    <li>繪本</li>
                </ul>
            </div>
        </div>
        <div class="header_link">
            <ul>
                <li>
                    <svg width="1.1vw" height="1.1vw" viewBox="0 0 22 20" fill="none"
                         xmlns="http://www.w3.org/2000/svg">
                        <path d="M8.94965 9.24365L1.60819 15.6852C0.797271 16.3967 0.797271 17.5503 1.60819 18.2618C2.41909 18.9733 3.73385 18.9733 4.54476 18.2618L11.8862 11.8203"
                              stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M16.3651 12.1523L20.3917 15.6853C21.2027 16.3968 21.2027 17.5505 20.3917 18.2619C19.5809 18.9735 18.2661 18.9735 17.4552 18.2619L11.0093 12.6063"
                              stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M5.50522 4.95963L3.30278 5.60379L1.10034 2.38304L2.56863 1.09473L6.23937 3.02718L5.50522 4.95963ZM5.50522 4.95963L8.44367 7.53788"
                              stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M8.94955 9.2435C8.07349 7.28218 8.24477 4.70872 10.0508 3.12408C11.8568 1.53943 15.1898 1.19163 17.0252 2.15785L13.8682 4.9278L13.5748 7.76186L16.8048 7.50441L19.9617 4.73445C21.063 6.34483 20.6666 9.26929 18.8606 10.8539C17.0545 12.4385 14.1215 12.5889 11.8862 11.8201"
                              stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    </i><a href="" class=" link-underline link-underline-opacity-0 text-secondary"> 賣場管理</a>
                </li>
                <li>
                    <svg xmlns="http://www.w3.org/2000/svg" width="1.1vw" height="1.1vw   " viewBox="0 0 20 22"
                         fill="none">
                        <path d="M1 21V19.75C1 14.9175 4.91751 11 9.75 11C14.5825 11 18.5 14.9175 18.5 19.75V21"
                              stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M9.75 11C12.5114 11 14.75 8.76138 14.75 6C14.75 3.23857 12.5114 1 9.75 1C6.98857 1 4.75 3.23857 4.75 6C4.75 8.76138 6.98857 11 9.75 11Z"
                              stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    </i><a href="" class=" link-underline link-underline-opacity-0 text-secondary"> 會員中心</a>
                </li>
                <li>
                    <svg xmlns="http://www.w3.org/2000/svg" width="1.1vw" height="1.1vw" viewBox="0 0 17 20"
                         fill="none">
                        <path d="M13.5 9.86888H15.25C15.6642 9.86888 16 10.1635 16 10.5269V17.985C16 18.3484 15.6642 18.643 15.25 18.643H1.75C1.33579 18.643 1 18.3484 1 17.985V10.5269C1 10.1635 1.33579 9.86888 1.75 9.86888H3.5M13.5 9.86888V5.48181C13.5 4.01945 12.5 1.09473 8.5 1.09473C4.5 1.09473 3.5 4.01945 3.5 5.48181V9.86888M13.5 9.86888H3.5"
                              stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <a href="/Login" id="login" class=" link-underline link-underline-opacity-0 text-secondary"> 註冊/登入</a>
                </li>
            </ul>
        </div>
        <div class="cart_container">
            <svg xmlns="http://www.w3.org/2000/svg" width="2.7vw" height="2.7vw" viewBox="0 0 40 32" fill="none">
                <path d="M39.1404 6.20728C38.947 5.97764 38.6949 5.79109 38.4043 5.66266C38.1136 5.53422 37.7927 5.4675 37.4673 5.46788L12.6088 5.48008L12.3246 4.26477C11.7939 1.79221 9.3536 -0.00140304 6.5207 8.23529e-07L2.0818 0.0021945C0.93 0.00272095 -0.00059971 0.821964 2.89972e-07 1.83082C0.00070029 2.83967 0.9323 3.65804 2.0842 3.65751L6.523 3.65532C7.352 3.65488 8.071 4.19554 8.2382 4.96854L8.869 7.67502C8.869 7.67862 8.8732 7.68046 8.8732 7.68414V7.69327L11.7886 19.5716C11.8884 19.9803 12.145 20.3466 12.5156 20.6092C12.8862 20.8718 13.3482 21.0149 13.8246 21.0145L30.7927 21.0061C33.4257 21.0049 35.4557 19.5545 36.2102 17.1727L39.46 7.82822C39.6534 7.27431 39.5322 6.67301 39.1403 6.20719L39.1404 6.20728ZM16.6801 23.7546C14.3826 23.7558 12.5151 25.3961 12.5165 27.412C12.5178 29.4279 14.3872 31.0664 16.6848 31.0653C18.9823 31.0641 20.8498 29.4238 20.8485 27.4079C20.8472 25.392 18.9777 23.7535 16.6801 23.7546ZM30.2196 23.748C27.9221 23.7491 26.0546 25.3894 26.056 27.4054C26.0573 29.4212 27.9267 31.0598 30.2243 31.0586C32.5218 31.0575 34.3893 29.4172 34.388 27.4013C34.3867 25.3854 32.5172 23.7468 30.2196 23.748Z"
                      fill="white"/>
            </svg>
        </div>
    </div>
</nav>
<h1 class="text-center mt-4 mb-0" style="font-size:3vw">結帳</h1>
<hr class="custom-hr">
<hr class="my-2 text-center mx-auto mb-0 " style=" boarder-color:red;width:83vw">

<div class="checkout-container"2>
<div class="container2">
<div class="cart-item-head">
    <div class="item-info">
        <p>商品資訊</p>
    </div>
    <div class="item-name">
        <p></p>
    </div>
    <div class="item-model" style="margin-left:-0.8vw">
        <p>商品規格</p>
    </div>
    <div class="item-unit-head" style="margin-left:1.8vw">
        <p>商品單價</p>
    </div>
    <div class="item-quantity-head">
        <p>下單數量</p>
    </div>
    <div class="item-total-head">
        <p>價格總價</p>
    </div>
</div>
</div>
</div>

<div class="checkout-container">
    <div class="container">
        <div class="cart-item-head">
            <div class="item-info">
                <p>商品資訊</p>
            </div>
            <div class="item-name">
                <p></p>
            </div>
            <div class="item-model" style="padding-left:0.8vw;">
                <p>商品規格</p>
            </div>
            <div class="item-unit-head">
                <p>商品單價</p>
            </div>
            <div class="item-quantity-head">
                <p>下單數量</p>
            </div>
            <div class="item-total-head">
                <p>價格總價</p>
            </div>
        </div>
        <div class="cart-item">
            <img id="productImg1" src="https://down-tw.img.susercontent.com/file/tw-11134207-7qukz-lg3gbyeti5gq16" alt="Product Image">
            <div class="item-name">
                <P id="productName1">男士休閒襯衫</P>
            </div>
            <div class="item-model">
                <p id="model1">黑,M</p>
            </div>
            <div class="item-unit">
                <p id="price1">900</p>
            </div>
            <div class="item-quantity">
                <p id="quantity1">10</p>
            </div>
            <div class="item-total">
                <p>Total Price</p>
            </div>
        </div>

        <!-- 添加更多商品行 -->
        <div class="cart-item">
            <img src="./images/ball2.png" alt="Product Image">
            <div class="item-name">
                <p>Product Name</p>
            </div>
            <div class="item-model">
                <p>Unit Price</p>
            </div>
            <div class="item-unit">
                <p>222</p>
            </div>
            <div class="item-quantity">
                <p>1</p>
            </div>
            <div class="item-total">
                <p>Total Price</p>
            </div>
        </div>


    </div>
</div>

<form  id="checkoutForm">
    <div class="container" style="padding-left:3.5vw">
        <div class="row">
            <div class="col-sm-6">
                <div class="form-group row" style=" height:50px">
                    <label for="name" class="col-sm-3 col-form-label form-p"><p class="text-sm">姓名:</p></label>
                    <div class="col-sm-5">
                        <input type="name" class="form-control" id="name">
                    </div>
                </div>
                <div class="form-group row" style=" height:50px">
                    <label for="email" class="col-sm-3 col-form-label form-p"><p class="">電話:</p></label>
                    <div class="col-sm-5">
                        <input type="email" class="form-control" id="email">
                    </div>
                </div>
                <div class="form-group row" style=" height:50px">
                    <label for="email" class="col-sm-3 col-form-label form-p"><p class="text-sm">收件門市:</p>
                    </label>
                    <div class="col-sm-5">
                        <input class="form-control" id="shippingAddress">
                    </div>
                </div>

            </div>
            <div class="col-sm-6">
                <div class="form-group row" style="height:50px">
                    <label for="email" class="col-sm-3 col-form-label text-center d-flex align-items-center"><p
                            class="text-sm">買家備註:</p></label>
                    <div class="col-sm-8">
                            <textarea class="form-control" id="buyerNote" placeholder="請輸入買家備註"
                                      rows="5"></textarea>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <div id="couponContainer" class="container coupon-container">
        <div class="">
            <p class="text-sm">優惠券:</p>
        </div>
    </div>
    <div class="container">
        <div class="container-checkout">
            <div class="payment-options">
                <div class="payment-option" style="padding-top:2px">
                    <p class="text-sm">付款方式:</p>
                </div>
                <div class="payment-options">
                    <div id="ECPayPayment"></div>
                    <input type="radio" id="ecpayment" name="payment" value="ecpayment">
                    <label for="ecpayment">綠界支付</label>
                    <input type="radio" id="cash" name="payment" value="cash">
                    <label for="cash">貨到付款</label>
                </div>
            </div>

        </div>
        <div id="orderSummary" class="container">
            <div class="summary-item">
                <div class="summary-label">
                    <p>商品數量:</p>
                </div>
                <div class="summary-value">
                    <p id="checkOutQuantity">0</p>
                </div>
            </div>
            <div class="summary-item">
                <p class="summary-label">折扣金額:$</p>
                <p id="discountAmount" class="summary-value">0.00</p>
            </div>
            <div class="summary-item">
                <p class="summary-label">總金額:$</p>
                <p id="checkOutTotal" class="summary-value">0.00</p>
            </div>

            <button id="payButtonEcpay" type="submit" class="submit-btn" onclick="redirectToPayment()">下訂單</button>
            <button id="payButtonCash" style="display: none"  type="submit" class="submit-btn" onclick="redirectToPaymentCash()">下訂單</button>

            <input type="hidden" id="checkOutTotalInput" name="checkOutTotalInput" value="0">
            <input type="hidden" id="paymentInput" name="paymentInput" value="0">
            <input type="hidden" id="statusInput" name="statusInput" value="0">
            <input type="hidden" id="userIDInput" name="userIDInput" value="0">
            <input type="hidden" id="discountInput" name="discountInput" value="0">
        </div>
    </div>
</form>
</div>

<script type="module">
    import {auth} from "./js/firebase.js";
    // 当 DOM 完全加载后执行
    document.addEventListener('DOMContentLoaded', function() {
        auth.onAuthStateChanged(user => {
            if (user) {
                user.getIdToken().then(token => {
                    fetch(`/09_checkoutPage/shoppingCart/cartItems`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ token })
                    })
                        .then(response => response.json())
                        .then(cartItems => {
                            // 假设您有一个函数来渲染购物车项目
                            renderCartItems(cartItems);
                        })
                        .catch(error => console.error('Error:', error));
                });
            } else {
                console.log("用戶未登錄");
            }
        });
    });



    // function getCheckOutDetail(userID) {
    //     fetch(`/checkoutDetail/${userID}`)
    //         .then(response => response.json())
    //         .then(details => {
    //             return details; // 直接返回字符串
    //         })
    //         .catch(error => console.error('Error:', error));
    // }
    function getProductImages(productID) {
        return fetch(`/09_checkoutPage/${productID}/images`)
            .then(response => {
                if(response.ok) {
                    return response.json();
                }
                throw new Error('Failed to fetch product details');
            })
            .then(images => {
                return images; // 直接返回字符串
            })
            .catch(error => console.error('Error:', error));
    }

    // 獲取產品名稱的函數
    function getProductName(productID) {
        return fetch(`/09_checkoutPage/product/details/${productID}`)
            .then(response => {
                if(response.ok) {
                    return response.text();
                }
                throw new Error('Failed to fetch product details');
            })
            .then(productName => {
                return productName; // 直接返回字符串
            })
            .catch(error => console.error('Error:', error));
    }

    function renderCartItems(cartItems) {
        const cartContainer = document.querySelector('.container'); // 确保选择正确的容器
        cartContainer.innerHTML = ''; // 清空现有内容
        let totalQuantity = 0; // 初始化总数量累加器
        let totalAmount = 0; // 初始化总金额累加器

        // 使用 Promise.all 确保所有异步操作完成
        const promises = cartItems.map(item => {
            return getProductName(item.productID).then(productName => {
                return getProductImages(item.productID).then(images => {
                    const imageSrc = images.length > 0 ? images[0] : 'default-image-path';
                    const totalPrice = item.price * item.quantity;
                    totalQuantity += item.quantity; // 累加商品数量
                    totalAmount += totalPrice; // 累加商品总价

                    const cartItemElement = document.createElement('div');
                    cartItemElement.classList.add('cart-item');
                    cartItemElement.innerHTML = `
                    <img src="${imageSrc}" alt="Product Image">
                    <div class="item-name">
                        <p>${productName}</p>
                    </div>
                    <div class="item-model">
                        <p>${item.models}</p>
                    </div>
                    <div class="item-unit">
                        <p>${item.price}</p>
                    </div>
                    <div class="item-quantity">
                        <p>${item.quantity}</p>
                    </div>
                    <div class="item-total">
                        <p>$${totalPrice.toFixed(2)}</p>
                    </div>
                `;
                    cartContainer.appendChild(cartItemElement);
                });
            });
        });

        // 等待所有商品处理完成后更新总数量和总金额
        Promise.all(promises).then(() => {
            document.getElementById('checkOutQuantity').textContent = totalQuantity; // 更新总数量
            document.getElementById('checkOutTotal').textContent = `${totalAmount}`; // 更新总金额

            // 更新隐藏的 input 字段，以便可以提交总价
            document.getElementById('checkOutTotalInput').value = totalAmount;
        });

    }

</script>
<script>
    // 监听綠界支付选项的变化
    document.getElementById('ecpayment').addEventListener('change', function() {
        if(this.checked) {
            // 当选中綠界支付时，设置隐藏输入字段的值为1
            document.getElementById('paymentInput').value = "1";
            document.getElementById('statusInput').value = "1";
        }
    });

    // 监听貨到付款选项的变化
    document.getElementById('cash').addEventListener('change', function() {
        if(this.checked) {
            // 当选中貨到付款时，设置隐藏输入字段的值为2
            document.getElementById('paymentInput').value = "2";
            document.getElementById('statusInput').value = "2";
        }
    });
</script>

<script>
    function redirectToPayment() {
        fetch('/ecpayCheckout', {
            method: 'POST'
        }).then(res => res.text())
            .then(data => {
                    var div = document.createElement('div');
                    div.innerHTML = data;

                    // 將 div 中的 form 元素添加到 body 中
                    var form = div.querySelector('form');
                    if (form) {
                        document.body.appendChild(form);

                        // 提交表單
                        form.submit();
                    } else {
                        console.error('Form element not found in HTML content.');
                    }
                }
            )
            .catch(error => {
                console.error('Fetch error:', error);
            });
    }
</script>
<script>
document.getElementById('payButtonEcpay').addEventListener('click', function(event) {
event.preventDefault(); // 阻止表单默认提交行为

    const buyerNote = document.getElementById('buyerNote').value;
    const shippingAddress = document.getElementById('shippingAddress').value;
    const checkOutTotalInput = document.getElementById('checkOutTotalInput').value;
    const paymentInput = document.getElementById('paymentInput').value;
    const statusInput = document.getElementById('statusInput').value;
    const userIDInput = document.getElementById('userIDInput').value;

// 创建提交到后端的数据对象
    const orderData = {
        buyerComment: buyerNote,
        shippingAddress: shippingAddress,
        totalPrice: checkOutTotalInput,
        paymentID: paymentInput,
        orderStatus: statusInput,
        buyerID: userIDInput,

    };

// 使用 fetch API 发送数据到后端
fetch('/09_checkoutPage/submitOrder', {
method: 'POST',
headers: {
'Content-Type': 'application/json',


},
body: JSON.stringify(orderData),
})
.then(response => response.json())
.then(data => {
// 处理响应数据
console.log('Order submitted successfully', data);
})
.catch((error) => {
// 处理错误情况
console.error('Error:', error);
});
});
</script>
<script>
    function redirectToPaymentCash() {
        window.location.href = '/Dealdove';
    }

</script>
<script>
    document.getElementById('payButtonCash').addEventListener('click', function(event) {
        event.preventDefault(); // 阻止表单默认提交行为

        const buyerNote = document.getElementById('buyerNote').value;
        const shippingAddress = document.getElementById('shippingAddress').value;
        const checkOutTotalInput = document.getElementById('checkOutTotalInput').value;
        const paymentInput = document.getElementById('paymentInput').value;
        const statusInput = document.getElementById('statusInput').value;
        const userIDInput = document.getElementById('userIDInput').value;


// 创建提交到后端的数据对象
        const orderData = {
            buyerComment: buyerNote,
            shippingAddress: shippingAddress,
            totalPrice: checkOutTotalInput,
            paymentID: paymentInput,
            orderStatus: statusInput,
            buyerID: userIDInput,
        };

// 使用 fetch API 发送数据到后端
        fetch('/09_checkoutPage/submitOrder', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(orderData),
        })
            .then(response => response.json())
            .then(data => {
// 处理响应数据
                console.log('Order submitted successfully', data);
            })
            .catch((error) => {
// 处理错误情况
                console.error('Error:', error);
            });
    });
</script>
<script type="module">
    import { auth } from "./js/firebase.js"; // 确保已正确导入Firebase认证模块

    auth.onAuthStateChanged(user => {
        if (user) {
            const userID = user.uid; // uid 是用户的唯一标识符
            document.getElementById('userIDInput').value = userID;
        } else {
            // 用户未登录
            console.log("未登錄");
        }
    });

</script>
<script>
    window.onload = function() {
        // 获取 radio button 和按钮元素
        var cashRadio = document.getElementById('cash');
        var ecpayRadio = document.getElementById('ecpayment'); // 获取绿界支付的 radio button
        var payButtonCash = document.getElementById('payButtonCash');
        var payButtonEcpay = document.getElementById('payButtonEcpay');

        // 为货到付款 radio button 添加 change 事件监听器
        cashRadio.addEventListener('change', function() {
            if (this.checked) {
                // 当选择货到付款时，改变按钮显示状态
                payButtonCash.style.display = 'block'; // 显示
                payButtonEcpay.style.display = 'none'; // 隐藏
            }
        });

        // 为绿界支付 radio button 添加 change 事件监听器
        ecpayRadio.addEventListener('change', function() {
            if (this.checked) {
                // 当选择绿界支付时，改变按钮显示状态
                payButtonEcpay.style.display = 'block'; // 显示
                payButtonCash.style.display = 'none'; // 隐藏
            }
        });
    };
</script>

<script type="module">
    import { auth } from "./js/firebase.js";

    document.addEventListener('DOMContentLoaded', function() {
        const couponContainer = document.querySelector('.container.coupon-container');

        auth.onAuthStateChanged(user => {
            if (user) {
                user.getIdToken().then(token => {
                    fetch(`/09_checkoutPage/userCoupons`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ token })
                    })
                        .then(response => response.json())
                        .then(coupons => {
                            if (Array.isArray(coupons)) {
                                const detailsPromises = coupons.map((coupon, index) => { // 确保这里传递了index参数
                                    if (coupon.couponBaseID) {
                                        return getCouponDetails(coupon.couponBaseID)
                                            .then(couponBase => createCouponElement(couponBase, index)); // index 在这里被使用
                                    } else {
                                        console.error('優惠券沒有有效的 couponBaseID', coupon);
                                        return null;
                                    }
                                });

                                Promise.all(detailsPromises).then(elements => {
                                    elements.forEach(element => {
                                        if (element) {
                                            couponContainer.appendChild(element);
                                        }
                                    });
                                });
                            } else {
                                console.error('返回的優惠券數據不是一個數組', coupons);
                            }
                        })
                        .catch(error => console.error('Error:', error));
                });
            } else {
                console.log("用戶未登錄");
            }
        });
    });

    function getCouponDetails(couponBaseID) {
        return fetch(`/09_checkoutPage/couponBaseDetails/${couponBaseID}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log(data); // 打印出响应数据来检查结构
                return data; // 确保这里返回的是正确的对象
            })
            .catch(error => {
                console.error('Error fetching coupon base details:', error);
            });
    }

    // 假设你已经有一个函数来初始化或更新购物车项目和总金额
    function initializeOrUpdateCart() {
        // 初始化或更新购物车总金额显示逻辑
        // 假设这里你已经计算了不包含折扣的总金额并更新了 checkOutTotal 和 checkOutTotalInput 的值
        const totalAmountWithoutDiscount = parseFloat(document.getElementById('checkOutTotal').textContent);
        document.getElementById('checkOutTotalInput').value = totalAmountWithoutDiscount;
        updateTotalAmountWithDiscount(); // 调用更新总金额（包含折扣）的函数
    }

    function updateTotalAmountWithDiscount() {
        // 获取原始总金额和折扣金额
        const totalAmountWithoutDiscount = parseFloat(document.getElementById('checkOutTotalInput').value);
        const discountAmount = parseFloat(document.getElementById('discountInput').value);

        // 计算包含折扣的新总金额
        const totalAmountWithDiscount = totalAmountWithoutDiscount - discountAmount;

        // 更新总金额显示
        document.getElementById('checkOutTotal').textContent = totalAmountWithDiscount;

        // 重要：更新隐藏输入字段以反映折扣后的总金额，确保这是传递到数据库的金额
        document.getElementById('checkOutTotalInput').value = totalAmountWithDiscount;
    }

    function createCouponElement(couponBase, index) {
        let targetContainer = document.getElementById("couponContainer");

        // 确保每行显示的优惠券数量（例如：每行3个）
        const couponsPerRow = 4;
        let couponRow;
        if (index % couponsPerRow === 0) {
            couponRow = document.createElement("div");
            couponRow.className = "coupon-row";
            couponRow.style.display = "flex"; // 使用Flex布局
            couponRow.style.justifyContent = "space-around"; // 子元素之间平均分配空间
            targetContainer.appendChild(couponRow);
        } else {
            couponRow = targetContainer.querySelector(".coupon-row:last-child");
        }

        const couponCard = document.createElement("div");
        couponCard.className = "coupon-card";
        couponCard.style.display = "flex";
        couponCard.style.alignItems = "center";
        couponCard.style.margin = "10px"; // 适当的外边距
        couponCard.style.padding = "10px"; // 适当的内边距
        couponCard.style.boxShadow = "0 2px 4px rgba(0,0,0,0.1)"; // 轻微的阴影效果
        couponCard.style.cursor = "pointer"; // 使其在hover时显示为指针

        couponCard.addEventListener('click', function() {
            // 清除之前选中的优惠券的选中状态
            document.querySelectorAll('.coupon-card.selected').forEach(function(card) {
                card.classList.remove('selected');
            });

            // 将当前优惠券设为选中状态
            this.classList.add('selected');

            // 更新折扣金额显示
            const discountAmountEl = document.getElementById('discountAmount');
            discountAmountEl.textContent = couponBase.discount; // 格式化折扣金额，保留两位小数

            // 更新隐藏字段或其他需要使用折扣值的地方
            document.getElementById('discountInput').value = couponBase.discount;

            // 重新计算并更新总金额（包含折扣）
            updateTotalAmountWithDiscount();
        });

        const img = document.createElement("img");
        img.src = "./images/coupon2.png";
        img.style.width = "100px"; // 固定图片大小
        img.style.height = "auto";
        img.style.marginRight = "20px"; // 图片和详情之间的间隔
        couponCard.appendChild(img);

        const details = document.createElement("div");
        details.style.marginLeft = "1vw";
        details.className = "product-details";

        const couponCode = document.createElement("div");
        couponCode.innerText = couponBase.couponName;
        details.appendChild(couponCode);

        const couponNumber = document.createElement("p");
        couponNumber.innerText = "折扣碼 " + couponBase.couponCode;
        details.appendChild(couponNumber);

        const productPricing = document.createElement("div");
        productPricing.className = "product-pricing";

        const conditions = document.createElement("div");
        conditions.innerText = "使用條件" +couponBase.minimumAmount + "-" + couponBase.discount;
        details.appendChild(conditions);

        const expirationDate = new Date(couponBase.expirationDate);
        const formattedDate = `${expirationDate.getFullYear()}-${String(expirationDate.getMonth() + 1).padStart(2, '0')}-${String(expirationDate.getDate()).padStart(2, '0')}  ${String(expirationDate.getHours()).padStart(2, '0')}:${String(expirationDate.getMinutes()).padStart(2, '0')}`;
        const exdate = document.createElement("p");
        exdate.innerText = "有效期限至 " + formattedDate;
        exdate.style.marginTop = "1vw";
        exdate.style.fontSize = "1vw";
        productPricing.appendChild(exdate);

        couponCard.appendChild(details);
        couponRow.appendChild(couponCard);
    }

    document.addEventListener('DOMContentLoaded', function() {
        initializeOrUpdateCart();
        // 加载优惠券和其它初始化逻辑...
    });


</script>


<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://ecpg-stage.ecpay.com.tw/Scripts/sdk-1.0.0.js?t=20210121100116"></script>
<script src="./js/search.js"></script>
</body>
</html>