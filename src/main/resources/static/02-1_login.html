<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/main.css">
    <link rel="stylesheet" href="./css/02-1_login.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://kit.fontawesome.com/e72344855b.js" crossorigin="anonymous"></script>
</head>

<body>
<header>
    <nav class="header">
        <div class="d-flex">
            <a class="iconBorder" href="./01_home_page.html"><img class="icon" src="./images/icon.png"></a>
        </div>
            <br><br>
    </nav>
</header>
<br>
<h1 class="login-title">登入</h1>
<div class="login-container">
    <!-- 登入按鈕在區塊上方 -->
    <div class="login-form">
        <div class="form-inputs">
            <label for="username">帳號:</label>
            <input type="text" id="username" name="username">

            <label for="password">密碼:</label>
            <input type="password" id="password" name="password">

            <label for="captcha">驗證碼:</label>
            <div class="captcha-group">
                <input type="text" id="captcha" name="captcha">
                <button class="captchaimg">
                    <img src="./images/x.png" alt="Captcha">
                </button>
            </div>
            <div class="account-options">
                <a href="http://127.0.0.1:5500/02-3_forget.html">
                    <button class="account-btn left">忘記密碼</button>
                </a>
                <a href="http://127.0.0.1:5500/02-2_register.html">
                    <button class="account-btn right">註冊帳號</button>
                </a>
            </div>
        </div>

        <div class="vertical-line-container">
            <div class="vertical-line"></div>
        </div>

        <div id="google-signIn" type="button" class="third-party-logins">
            <button class="google-login">
                <img src="./images/google.png" alt="Google">Google登入
            </button>
            <button id="facebook-signIn" type="button" class="facebook-login">
                <img src="./images/facebook.svg" alt="Facebook">Facebook登入
            </button>
        </div>
    </div>
</div>

<button id="login-button" class="login-button">登入</button>
<button id="test">123</button>

<br><br><br>
<footer>
    <div class="footer">
        <div>
            <ul class="footerList">
                <li class="h3">關於我們</li>
                <li>關於DealDove</li>
                <li>加入我們</li>
                <li>賣家中心</li>
                <li>限時特賣</li>
                <li>聯絡媒體</li>
            </ul>
        </div>
        <div>
            <ul class="footerList">
                <li class="h3">客服中心</li>
                <li>幫助中心</li>
                <li>退貨退款</li>
                <li>聯絡客服</li>
            </ul>
        </div>
        <div>
            <ul class="footerList">
                <li class="h3">關注我們</li>
                <li>關於DealDove</li>
                <li>加入我們</li>
                <li><img src="./images/icon _facebook.png"><span> </span>
                    <img src="./images/icon _instagram.png">
                </li>
            </ul>
        </div>
        <div>
            <ul class="footerList">
                <li class="h3">法律與隱私</li>
                <li>隱私權政策</li>
                <li>DealDove條款</li>
            </ul>
        </div>
        <img class="qrcode" src="./images/qrCode.png">
    </div>
</footer>

<!-- js -->
<script type="module">
    // 導入所需的 Firebase SDK
    import {initializeApp} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {getAnalytics} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
    import {
        getAuth,
        signInWithPopup,
        GoogleAuthProvider,
        FacebookAuthProvider,
        signOut,
        onAuthStateChanged,
        setPersistence,
        browserSessionPersistence
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    // Firebase 配置
    const firebaseConfig = {
        apiKey: "AIzaSyA0xrDB28Kk2gvgj-Ho0wvTNemqqkqytuo",
        authDomain: "dealdove-36d8c.firebaseapp.com",
        projectId: "dealdove-36d8c",
        storageBucket: "dealdove-36d8c.appspot.com",
        messagingSenderId: "997598982157",
        appId: "1:997598982157:web:8728a77f135fec514ba544",
        measurementId: "G-7ZRGD1VDM6"
    };


    // 初始化 Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);


    document.getElementById('google-signIn').addEventListener('click', () => {
        const provider = new GoogleAuthProvider();
        signInWithPopup(auth, provider)
            .then(result => {

                const user = result.user;
                // 正確獲取 ID Token
                return user.getIdToken();
            })
            .then(idToken => {
                // 在這裡你可以使用 idToken 進行後續的操作
                console.log('ID Token:', idToken);

                // 將 idToken 送回後端
                sendTokenToBackend(idToken);
            })
            .catch(error => {
                console.log(error);
            });
    });

    // 送 ID Token 回後端的函數
    function sendTokenToBackend(idToken) {
        const apiUrl = '/login3';
        const requestOptions = {
            method: 'POST',
            body: JSON.stringify({
                idToken: idToken
            }),
            headers: {'Content-Type': 'application/json;charset=utf-8'}
        };

        fetch(apiUrl, requestOptions)
            .then(response => response.json())
            .then(data => {
                // 在這裡處理後端的回應
                console.log('後端回應:', data);
            })
            .catch(error => {
                console.error('錯誤:', error);
            });
    }

    document.getElementById('login-button').addEventListener("click", function () {
        signOut(auth).then(() => {
            localStorage.clear();
            sessionStorage.clear();
            console.log("Logout success")
        }).catch((error) => {
            console.log(error)
        })
    });


    // 測試用
    document.getElementById('test').addEventListener('click', () => {
        const auth = getAuth();
        console.log(auth);
        onAuthStateChanged(auth, (user) => {
            console.log(user);
            if (user) {
                // 已登入
                const uid = user.uid;
                window.location.href = "01_home_page.html";
                console.log(uid);
            } else {
                // 未登入
                const provider = new GoogleAuthProvider();
                signInWithPopup(auth, provider)
                    .then(result => {
                        const user = result.user;


                        // 正確獲取 ID Token
                        return user.getIdToken();
                    })
                    .then(idToken => {
                        // 在這裡你可以使用 idToken 進行後續的操作
                        console.log('ID Token:', idToken);

                        // 將 idToken 送回後端
                        sendTokenToBackend(idToken);
                    })
                    .catch(error => {
                        console.log(error);
                    });
                console.log("not login")
            }
        })
    })


    // <!----------------------------- facebook登入---------- -->


    document.getElementById('facebook-signIn').addEventListener('click', () => {
        const provider = new FacebookAuthProvider();
        signInWithPopup(auth, provider).then(result => {
            // 獲取用戶資訊
            const user = result.user;
            // 用戶的唯一 ID
            const uid = user.uid;
            // 用戶的名字
            const displayName = user.displayName;
            // 用戶的電子郵件
            const email = user.email;
            // 用戶的頭像 URL
            const photoURL = user.photoURL;
            // 用戶登入提供者的相關資料
            const providerData = user.providerData;


            console.log(displayName);
            // 在這裡，您可以將用戶資料保存到狀態管理，或者發送到您的服務器進行進一步處理
            // 例如：
            // saveUserData(uid, displayName, email, photoURL);

            // 或更新 UI 以反映用戶已登入
            // updateUI(user);
            fetch("/login1", {
                method: 'POST',
                body: JSON.stringify({
                    'email': email,
                    'displayName': displayName,
                    'uid': uid
                }),
                headers: {'Content-Type': 'application/json;charset=utf-8'}
            }).then(console.log(res));
        }).catch(error => {
        });
    });


</script>

</body>

</html>